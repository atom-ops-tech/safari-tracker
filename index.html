<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gowsters Safari Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow-x: hidden;
        }
        
        /* Safari background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 50 Q25 30 50 50 T100 50' stroke='%23ffffff10' stroke-width='0.5' fill='none'/%3E%3Ccircle cx='20' cy='80' r='1' fill='%23ffffff08'/%3E%3Ccircle cx='80' cy='20' r='1' fill='%23ffffff08'/%3E%3Ccircle cx='60' cy='70' r='0.5' fill='%23ffffff05'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 100 Q75 80 100 100 T150 100' stroke='%23ffffff08' stroke-width='1' fill='none'/%3E%3C/svg%3E");
            background-position: 0 0, 50px 50px;
            background-size: 100px 100px, 200px 200px;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: 'üåç';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .family-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        h1 {
            color: #333;
            font-size: 26px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .safari-icon {
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .sync-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .online {
            background: #10b981;
            color: white;
            animation: glow-green 2s ease-in-out infinite;
        }
        
        @keyframes glow-green {
            0%, 100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }
        
        .offline {
            background: #f59e0b;
            color: white;
        }
        
        .user-info {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .user-info label {
            font-weight: bold;
            color: #667eea;
        }
        
        .user-info input {
            padding: 5px 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 5px;
            font-size: 14px;
            background: white;
            font-weight: bold;
            color: #333;
        }
        
        .welcome-message {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .animals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animal-btn {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .animal-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .animal-btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .animal-btn:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .animal-btn:active {
            transform: scale(0.95);
        }
        
        .animal-emoji {
            font-size: 36px;
            margin-bottom: 5px;
            display: block;
            animation: wiggle 2s ease-in-out infinite;
            animation-delay: calc(var(--index) * 0.1s);
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
        
        .animal-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .animal-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .animal-count.pop {
            animation: pop 0.3s ease-out;
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .add-custom {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 3px dashed #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        
        .add-custom:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            border-color: #667eea;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .sightings-list {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.6s ease-out 0.4s both;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sighting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .sighting-item:hover {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            transform: translateX(5px);
        }
        
        .sighting-user {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .sighting-info {
            flex: 1;
        }
        
        .sighting-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            font-weight: bold;
        }
        
        .btn-small:hover {
            transform: scale(1.1);
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .actions {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.6s ease-out 0.6s both;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInModal 0.3s ease-out;
        }
        
        @keyframes fadeInModal {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-content .emoji-animal-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .modal-content .tip-box {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .summary {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out 0.2s both;
        }
        
        .summary h2 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .stat {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .stat:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            background: linear-gradient(135deg, #fff, #f9fafb);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            font-weight: 600;
        }
        
        /* Notification Toast */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            animation: slideUpNotification 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .notification.success {
            background: #10b981;
            color: white;
        }
        
        .notification.error {
            background: #ef4444;
            color: white;
        }
        
        .notification.info {
            background: #3b82f6;
            color: white;
        }
        
        @keyframes slideUpNotification {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOutNotification {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="family-badge">GOWSTERS FAMILY</div>
            <h1><span class="safari-icon">ü¶Å</span> Safari Wildlife Tracker</h1>
            <div class="welcome-message" id="welcomeMessage"></div>
            <div class="status">
                <div class="sync-status" id="syncStatus">Checking...</div>
                <div class="user-info">
                    <label>Tracker:</label>
                    <input type="text" id="userName" placeholder="Your name" />
                </div>
            </div>
        </div>

        <div class="summary">
            <h2>üìä Trip Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-value" id="totalSightings">0</div>
                    <div class="stat-label">Total Sightings</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="uniqueAnimals">0</div>
                    <div class="stat-label">Unique Animals</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="todaySightings">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="pendingSync">0</div>
                    <div class="stat-label">Pending Sync</div>
                </div>
            </div>
        </div>

        <div class="animals-grid" id="animalsGrid">
            <!-- Common safari animals -->
        </div>

        <div class="sightings-list">
            <h2>üìù Recent Sightings</h2>
            <div id="sightingsList"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="syncNow(true)">üîÑ Force Sync</button>
            <button class="btn btn-secondary" onclick="exportData()">üìä Export Data</button>
            <button class="btn btn-secondary" onclick="downloadBackup()">üíæ Backup</button>
            <input type="file" id="restoreFile" style="display: none" accept=".json" onchange="restoreBackup(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">üìÇ Restore</button>
            <button class="btn btn-secondary" onclick="shareLink()">üîó Share Link</button>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Animal Sighting</h2>
            <div class="emoji-animal-row">
                <input type="text" id="modalEmoji" placeholder="üòä" style="width: 80px; text-align: center; font-size: 24px;">
                <input type="text" id="modalAnimal" placeholder="Search or type animal name" list="animalsList" style="flex: 1;">
            </div>
            <datalist id="animalsList">
                <option value="Hyena">üê∫</option>
                <option value="Wild Dog">üêï</option>
                <option value="Ostrich">ü¶Ü</option>
                <option value="Flamingo">ü¶©</option>
                <option value="Pelican">ü¶¢</option>
                <option value="Stork">ü¶§</option>
                <option value="Parrot">ü¶ú</option>
                <option value="Hornbill">üê¶</option>
                <option value="Mongoose">ü¶¶</option>
                <option value="Meerkat">üêøÔ∏è</option>
                <option value="Porcupine">ü¶î</option>
                <option value="Honey Badger">ü¶°</option>
                <option value="Pangolin">ü¶•</option>
                <option value="Aardvark">üêñ</option>
                <option value="Bushbaby">üêí</option>
                <option value="Vervet Monkey">üêµ</option>
                <option value="Chameleon">ü¶é</option>
                <option value="Python">üêç</option>
                <option value="Cobra">üêç</option>
                <option value="Tortoise">üê¢</option>
                <option value="Monitor Lizard">ü¶é</option>
                <option value="Frog">üê∏</option>
                <option value="Impala">ü¶å</option>
                <option value="Gazelle">ü¶å</option>
                <option value="Kudu">ü¶å</option>
                <option value="Springbok">ü¶å</option>
                <option value="Waterbuck">ü¶å</option>
                <option value="Eland">üêÇ</option>
                <option value="Wildebeest">üêÉ</option>
                <option value="Nyala">ü¶å</option>
                <option value="Bushbuck">ü¶å</option>
                <option value="Dik-dik">ü¶å</option>
                <option value="Jackal">ü¶ä</option>
                <option value="Serval">üêà</option>
                <option value="Caracal">üêà</option>
                <option value="Civet">ü¶ù</option>
                <option value="Genet">üêà</option>
                <option value="Bat">ü¶á</option>
                <option value="Butterfly">ü¶ã</option>
                <option value="Beetle">ü™≤</option>
                <option value="Spider">üï∑Ô∏è</option>
                <option value="Scorpion">ü¶Ç</option>
            </datalist>
            <input type="number" id="modalCount" placeholder="Count" value="1" min="1">
            <input type="text" id="modalNotes" placeholder="Notes (optional)">
            <div class="tip-box">
                üí° Tip: Choose from 40+ safari animals in the dropdown, or type any animal name! Add any emoji you want in the first field.
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveModal()">Save Sighting</button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal active" id="setupModal">
        <div class="modal-content">
            <div class="family-badge" style="margin-bottom: 15px;">GOWSTERS FAMILY</div>
            <h2>ü¶Å Welcome to Safari Tracker!</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Let's set up your tracker for the Gowsters family safari adventure!</p>
            <input type="text" id="setupName" placeholder="Your name (e.g., Sam)">
            <input type="text" id="serverUrl" placeholder="Server URL (optional)">
            <input type="password" id="serverPassword" placeholder="Family password (optional)">
            <div class="tip-box" style="margin-top: 10px; margin-bottom: 15px;">
                üí° Got a link from family? Just use that link and it'll set everything up automatically!
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="skipSetup()">Use Offline Only</button>
                <button class="btn btn-primary" onclick="saveSetup()">Start Tracking!</button>
            </div>
        </div>
    </div>

    <script>
        // Common safari animals with emojis
        const commonAnimals = [
            { name: 'Lion', emoji: 'ü¶Å' },
            { name: 'Elephant', emoji: 'üêò' },
            { name: 'Giraffe', emoji: 'ü¶í' },
            { name: 'Zebra', emoji: 'ü¶ì' },
            { name: 'Rhino', emoji: 'ü¶è' },
            { name: 'Hippo', emoji: 'ü¶õ' },
            { name: 'Leopard', emoji: 'üêÜ' },
            { name: 'Cheetah', emoji: 'üêÜ' },
            { name: 'Buffalo', emoji: 'üêÉ' },
            { name: 'Antelope', emoji: 'ü¶å' },
            { name: 'Warthog', emoji: 'üêó' },
            { name: 'Baboon', emoji: 'üêµ' },
            { name: 'Crocodile', emoji: 'üêä' },
            { name: 'Eagle', emoji: 'ü¶Ö' },
            { name: 'Vulture', emoji: 'ü¶Ö' }
        ];

        // Extended animal list with emojis for dropdown
        const additionalAnimals = {
            'Hyena': 'üê∫', 'Wild Dog': 'üêï', 'Ostrich': 'ü¶Ü', 'Flamingo': 'ü¶©',
            'Pelican': 'ü¶¢', 'Stork': 'ü¶§', 'Parrot': 'ü¶ú', 'Hornbill': 'üê¶',
            'Mongoose': 'ü¶¶', 'Meerkat': 'üêøÔ∏è', 'Porcupine': 'ü¶î', 'Honey Badger': 'ü¶°',
            'Pangolin': 'ü¶•', 'Aardvark': 'üêñ', 'Bushbaby': 'üêí', 'Vervet Monkey': 'üêµ',
            'Chameleon': 'ü¶é', 'Python': 'üêç', 'Cobra': 'üêç', 'Tortoise': 'üê¢',
            'Monitor Lizard': 'ü¶é', 'Frog': 'üê∏', 'Impala': 'ü¶å', 'Gazelle': 'ü¶å',
            'Kudu': 'ü¶å', 'Springbok': 'ü¶å', 'Waterbuck': 'ü¶å', 'Eland': 'üêÇ',
            'Wildebeest': 'üêÉ', 'Nyala': 'ü¶å', 'Bushbuck': 'ü¶å', 'Dik-dik': 'ü¶å',
            'Jackal': 'ü¶ä', 'Serval': 'üêà', 'Caracal': 'üêà', 'Civet': 'ü¶ù',
            'Genet': 'üêà', 'Bat': 'ü¶á', 'Butterfly': 'ü¶ã', 'Beetle': 'ü™≤',
            'Spider': 'üï∑Ô∏è', 'Scorpion': 'ü¶Ç'
        };

        // Track custom animals and their emojis
        let customAnimals = {};

        let sightings = [];
        let config = {
            userName: '',
            serverUrl: '',
            password: '',
            deviceId: generateId()
        };
        let isOnline = false;
        let editingSighting = null;

        // Initialize
        function init() {
            // Parse URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const urlName = urlParams.get('name');
            const urlPassword = urlParams.get('password');
            const urlServer = urlParams.get('server');
            
            loadConfig();
            loadSightings();
            
            // Apply URL parameters if provided and no existing config
            let hasUrlConfig = false;
            if (!config.serverUrl && (urlName || urlServer || urlPassword)) {
                if (urlName) config.userName = decodeURIComponent(urlName);
                if (urlPassword) config.password = decodeURIComponent(urlPassword);
                if (urlServer) config.serverUrl = decodeURIComponent(urlServer);
                saveConfig();
                hasUrlConfig = true;
            }
            
            // Skip setup modal if we have URL parameters or existing config
            if (config.userName || config.serverUrl || hasUrlConfig) {
                document.getElementById('setupModal').classList.remove('active');
            } else {
                // Pre-fill setup modal with URL params if available
                if (urlName) document.getElementById('setupName').value = decodeURIComponent(urlName);
                if (urlServer) document.getElementById('serverUrl').value = decodeURIComponent(urlServer);
                if (urlPassword) document.getElementById('serverPassword').value = decodeURIComponent(urlPassword);
            }
            
            if (config.serverUrl) {
                checkOnlineStatus();
                setInterval(checkOnlineStatus, 10000); // Check every 10 seconds
                setInterval(autoSync, 15000); // Auto-sync every 15 seconds
            }
            
            renderAnimals();
            updateDisplay();
            updateWelcomeMessage();
            
            document.getElementById('userName').value = config.userName || '';
            document.getElementById('userName').addEventListener('change', (e) => {
                config.userName = e.target.value;
                saveConfig();
                updateWelcomeMessage();
            });
        }

        function updateWelcomeMessage() {
            const welcomeEl = document.getElementById('welcomeMessage');
            if (config.userName) {
                const greetings = [
                    `Happy spotting, ${config.userName}! üåç`,
                    `${config.userName}'s wildlife adventure ü¶í`,
                    `Let's find some animals, ${config.userName}! üêò`,
                    `${config.userName} on safari! ü¶Å`
                ];
                welcomeEl.textContent = greetings[Math.floor(Math.random() * greetings.length)];
            } else {
                welcomeEl.textContent = 'Welcome to the Gowsters Safari! üåç';
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function loadConfig() {
            const saved = localStorage.getItem('safariConfig');
            if (saved) {
                config = { ...config, ...JSON.parse(saved) };
            }
        }

        function saveConfig() {
            localStorage.setItem('safariConfig', JSON.stringify(config));
        }

        function loadSightings() {
            const saved = localStorage.getItem('safariSightings');
            if (saved) {
                sightings = JSON.parse(saved);
            }
            const savedCustom = localStorage.getItem('customAnimals');
            if (savedCustom) {
                customAnimals = JSON.parse(savedCustom);
            }
        }

        function saveSightings() {
            localStorage.setItem('safariSightings', JSON.stringify(sightings));
            localStorage.setItem('customAnimals', JSON.stringify(customAnimals));
            updateDisplay();
        }

        function saveSetup() {
            config.userName = document.getElementById('setupName').value || 'Anonymous Gowster';
            config.serverUrl = document.getElementById('serverUrl').value;
            config.password = document.getElementById('serverPassword').value;
            
            if (config.serverUrl && !config.serverUrl.startsWith('http')) {
                config.serverUrl = 'https://' + config.serverUrl;
            }
            
            saveConfig();
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('userName').value = config.userName;
            updateWelcomeMessage();
            
            if (config.serverUrl) {
                checkOnlineStatus();
                setInterval(checkOnlineStatus, 10000);
                setInterval(autoSync, 30000);
            }
        }
        
        // Make saveSetup available globally
        window.saveSetup = saveSetup;

        function skipSetup() {
            config.userName = 'Anonymous Gowster';
            saveConfig();
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('userName').value = config.userName;
            updateWelcomeMessage();
        }
        
        // Make skipSetup available globally
        window.skipSetup = skipSetup;

        function renderAnimals() {
            const grid = document.getElementById('animalsGrid');
            grid.innerHTML = '';
            
            // Render common animals
            commonAnimals.forEach((animal, index) => {
                const count = sightings.filter(s => s.animal === animal.name && !s.deleted).length;
                const btn = document.createElement('div');
                btn.className = 'animal-btn';
                btn.style.setProperty('--index', index);
                btn.innerHTML = `
                    <div class="animal-emoji">${animal.emoji}</div>
                    <div class="animal-name">${animal.name}</div>
                    <div class="animal-count" id="count-${animal.name.replace(/\s/g, '')}">${count}</div>
                `;
                btn.onclick = () => addSighting(animal.name, 1, '', animal.emoji);
                grid.appendChild(btn);
            });
            
            // Render custom animals that have been tracked
            Object.entries(customAnimals).forEach(([name, emoji], index) => {
                // Skip if already in common animals
                if (commonAnimals.some(a => a.name === name)) return;
                
                const count = sightings.filter(s => s.animal === name && !s.deleted).length;
                if (count > 0) {
                    const btn = document.createElement('div');
                    btn.className = 'animal-btn';
                    btn.style.setProperty('--index', commonAnimals.length + index);
                    btn.innerHTML = `
                        <div class="animal-emoji">${emoji || 'ü¶¥'}</div>
                        <div class="animal-name">${name}</div>
                        <div class="animal-count" id="count-${name.replace(/\s/g, '')}">${count}</div>
                    `;
                    btn.onclick = () => addSighting(name, 1, '', emoji);
                    grid.appendChild(btn);
                }
            });
            
            // Add custom button
            const customBtn = document.createElement('div');
            customBtn.className = 'animal-btn add-custom';
            customBtn.innerHTML = `
                <div class="animal-emoji">‚ûï</div>
                <div class="animal-name">Add Animal</div>
            `;
            customBtn.onclick = () => openModal();
            grid.appendChild(customBtn);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOutNotification 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
        
        // Make showNotification available globally
        window.showNotification = showNotification;
        
        function showSuccessAnimation() {
            showNotification('‚ú® Logged!', 'success');
        }

        function addSighting(animal, count = 1, notes = '', emoji = '') {
            const sighting = {
                id: generateId(),
                animal,
                emoji: emoji || customAnimals[animal] || 'ü¶¥',
                count: parseInt(count),
                notes,
                timestamp: new Date().toISOString(),
                user: config.userName || 'Anonymous Gowster',
                deviceId: config.deviceId,
                synced: false,
                deleted: false
            };
            
            // Store custom animal emoji if new
            let isNewCustomAnimal = false;
            if (emoji && !commonAnimals.some(a => a.name === animal) && !customAnimals[animal]) {
                customAnimals[animal] = emoji;
                isNewCustomAnimal = true;
            }
            
            sightings.push(sighting);
            saveSightings();
            
            if (isNewCustomAnimal) {
                renderAnimals(); // Re-render to show new custom animal
            } else {
                updateAnimalCount(animal);
            }
            
            showSuccessAnimation();
        }

        function updateAnimalCount(animal) {
            const countEl = document.getElementById(`count-${animal.replace(/\s/g, '')}`);
            if (countEl) {
                const count = sightings.filter(s => s.animal === animal && !s.deleted).length;
                countEl.textContent = count;
                countEl.classList.add('pop');
                setTimeout(() => countEl.classList.remove('pop'), 300);
            } else {
                // If element doesn't exist, it might be a new custom animal, re-render
                renderAnimals();
            }
        }

        function openModal(sighting = null) {
            editingSighting = sighting;
            const modal = document.getElementById('editModal');
            
            if (sighting) {
                document.getElementById('modalTitle').textContent = 'Edit Sighting';
                document.getElementById('modalAnimal').value = sighting.animal;
                document.getElementById('modalEmoji').value = sighting.emoji || '';
                document.getElementById('modalCount').value = sighting.count;
                document.getElementById('modalNotes').value = sighting.notes || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Add Animal Sighting';
                document.getElementById('modalAnimal').value = '';
                document.getElementById('modalEmoji').value = '';
                document.getElementById('modalCount').value = '1';
                document.getElementById('modalNotes').value = '';
            }
            
            modal.classList.add('active');
        }
        
        // Make openModal available globally for inline onclick
        window.openModal = openModal;

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingSighting = null;
        }
        
        // Make closeModal available globally
        window.closeModal = closeModal;

        function saveModal() {
            const animal = document.getElementById('modalAnimal').value.trim();
            const emoji = document.getElementById('modalEmoji').value.trim() || 'ü¶¥';
            const count = document.getElementById('modalCount').value;
            const notes = document.getElementById('modalNotes').value.trim();
            
            if (!animal) {
                showNotification('Please enter an animal name', 'error');
                return;
            }
            
            if (editingSighting) {
                const oldAnimal = editingSighting.animal;
                editingSighting.animal = animal;
                editingSighting.emoji = emoji;
                editingSighting.count = parseInt(count);
                editingSighting.notes = notes;
                editingSighting.synced = false;
                
                // Update custom animals record
                if (!commonAnimals.some(a => a.name === animal)) {
                    customAnimals[animal] = emoji;
                }
                
                saveSightings();
                
                // Re-render if animal name changed
                if (oldAnimal !== animal) {
                    renderAnimals();
                } else {
                    updateAnimalCount(animal);
                }
                
                showNotification('‚úèÔ∏è Updated!', 'success');
            } else {
                addSighting(animal, count, notes, emoji);
            }
            
            closeModal();
        }
        
        // Make saveModal available globally
        window.saveModal = saveModal;

        function deleteSighting(id) {
            const sighting = sightings.find(s => s.id === id);
            if (sighting) {
                sighting.deleted = true;
                sighting.synced = false;
                saveSightings();
                showNotification('üóëÔ∏è Deleted', 'error');
            }
        }
        
        function editSighting(id) {
            const sighting = sightings.find(s => s.id === id);
            if (sighting) {
                openModal(sighting);
            }
        }
        
        // Make editSighting available globally
        window.editSighting = editSighting;

        function updateDisplay() {
            // Update counts
            const activeSightings = sightings.filter(s => !s.deleted);
            const totalCount = activeSightings.reduce((sum, s) => sum + s.count, 0);
            const uniqueCount = new Set(activeSightings.map(s => s.animal)).size;
            
            const today = new Date().toDateString();
            const todayCount = activeSightings
                .filter(s => new Date(s.timestamp).toDateString() === today)
                .reduce((sum, s) => sum + s.count, 0);
            
            const pendingCount = sightings.filter(s => !s.synced).length;
            
            document.getElementById('totalSightings').textContent = totalCount;
            document.getElementById('uniqueAnimals').textContent = uniqueCount;
            document.getElementById('todaySightings').textContent = todayCount;
            document.getElementById('pendingSync').textContent = pendingCount;
            
            // Update sync status with pending count
            if (isOnline && config.serverUrl) {
                const status = document.getElementById('syncStatus');
                if (pendingCount > 0) {
                    status.textContent = `üåê Online (${pendingCount} pending)`;
                } else {
                    status.textContent = 'üåê All synced';
                }
            }
            
            // Update recent sightings list
            const list = document.getElementById('sightingsList');
            list.innerHTML = '';
            
            const recent = [...activeSightings]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);
            
            recent.forEach(sighting => {
                const item = document.createElement('div');
                item.className = 'sighting-item';
                
                const time = new Date(sighting.timestamp);
                const timeStr = time.toLocaleString();
                
                // Get emoji for display
                let emoji = sighting.emoji;
                if (!emoji) {
                    const commonAnimal = commonAnimals.find(a => a.name === sighting.animal);
                    emoji = commonAnimal ? commonAnimal.emoji : (customAnimals[sighting.animal] || 'ü¶¥');
                }
                
                item.innerHTML = `
                    <div class="sighting-info">
                        <strong>${emoji} ${sighting.count} √ó ${sighting.animal}</strong>
                        <span class="sighting-user">${sighting.user}</span>
                        <br>
                        <small style="color: #999;">${timeStr}</small>
                        ${sighting.notes ? `<br><small style="color: #666;">üìù ${sighting.notes}</small>` : ''}
                    </div>
                    <div class="sighting-actions">
                        <button class="btn-small btn-edit" onclick="editSighting('${sighting.id}')">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="deleteSighting('${sighting.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            // Update all animal counts
            commonAnimals.forEach(animal => {
                updateAnimalCount(animal.name);
            });
        }

        async function checkOnlineStatus() {
            if (!config.serverUrl) {
                updateOnlineStatus(false);
                return;
            }
            
            // Use requestIdleCallback to avoid blocking UI
            const checkStatus = async () => {
                try {
                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 3000)
                    );
                    
                    const fetchPromise = fetch(config.serverUrl + '/health', {
                        method: 'GET',
                        headers: {
                            'X-Password': config.password
                        }
                    });
                    
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    updateOnlineStatus(response.ok);
                } catch (error) {
                    updateOnlineStatus(false);
                }
            };
            
            if ('requestIdleCallback' in window) {
                requestIdleCallback(checkStatus);
            } else {
                setTimeout(checkStatus, 0);
            }
        }

        function updateOnlineStatus(online) {
            isOnline = online;
            const status = document.getElementById('syncStatus');
            
            if (!config.serverUrl) {
                status.textContent = 'üìµ Offline Only';
                status.className = 'sync-status offline';
            } else if (online) {
                const pendingCount = sightings.filter(s => !s.synced).length;
                if (pendingCount > 0) {
                    status.textContent = `üåê Online (${pendingCount} pending)`;
                } else {
                    status.textContent = 'üåê All synced';
                }
                status.className = 'sync-status online';
            } else {
                status.textContent = 'üìµ Offline';
                status.className = 'sync-status offline';
            }
        }

        async function syncNow(showFeedback = true) {
            if (!isOnline || !config.serverUrl) {
                if (showFeedback) {
                    showNotification('üìµ Cannot sync - offline', 'error');
                }
                return;
            }
            
            // Run sync in background to avoid blocking UI
            const performSync = async () => {
                try {
                    // Send unsynced sightings
                    const unsynced = sightings.filter(s => !s.synced);
                    
                    if (unsynced.length > 0) {
                        const response = await fetch(config.serverUrl + '/sync', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Password': config.password
                            },
                            body: JSON.stringify({
                                deviceId: config.deviceId,
                                sightings: unsynced
                            })
                        });
                        
                        if (response.ok) {
                            // Mark as synced
                            unsynced.forEach(s => s.synced = true);
                            saveSightings();
                        }
                    }
                    
                    // Get all sightings from server
                    const response = await fetch(config.serverUrl + '/sightings', {
                        headers: {
                            'X-Password': config.password
                        }
                    });
                    
                    if (response.ok) {
                        const serverSightings = await response.json();
                        const newCount = mergeSightings(serverSightings);
                        if (showFeedback) {
                            if (newCount > 0) {
                                showNotification(`üîÑ Synced! ${newCount} new sightings`, 'success');
                            } else {
                                showNotification('‚úÖ All synced', 'success');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    if (showFeedback) {
                        showNotification('‚ùå Sync failed', 'error');
                    }
                }
            };
            
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => performSync());
            } else {
                setTimeout(performSync, 0);
            }
        }
        
        // Make syncNow available globally
        window.syncNow = syncNow;

        function mergeSightings(serverSightings) {
            const localIds = new Set(sightings.map(s => s.id));
            
            serverSightings.forEach(serverSighting => {
                if (!localIds.has(serverSighting.id)) {
                    sightings.push({ ...serverSighting, synced: true });
                    
                    // Store custom animal emoji if new
                    if (serverSighting.emoji && !commonAnimals.some(a => a.name === serverSighting.animal)) {
                        customAnimals[serverSighting.animal] = serverSighting.emoji;
                    }
                }
            });
            
            saveSightings();
        }

        async function autoSync() {
            if (isOnline && config.serverUrl) {
                const unsynced = sightings.filter(s => !s.synced);
                if (unsynced.length > 0) {
                    await syncNow();
                }
            }
        }

        function exportData() {
            const data = sightings.filter(s => !s.deleted);
            
            // Helper function to escape CSV values
            const escapeCSV = (str) => {
                if (str == null) return '';
                str = String(str);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            const csv = [
                ['Animal', 'Count', 'Date', 'Time', 'User', 'Notes'],
                ...data.map(s => {
                    const date = new Date(s.timestamp);
                    return [
                        escapeCSV(s.animal),
                        s.count,
                        date.toLocaleDateString(),
                        date.toLocaleTimeString(),
                        escapeCSV(s.user),
                        escapeCSV(s.notes || '')
                    ];
                })
            ].map(row => row.join(',')).join('\n');
            
            downloadFile(csv, `gowsters-safari-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }
        
        // Make exportData available globally
        window.exportData = exportData;

        function downloadBackup() {
            const backup = {
                version: 1,
                exportDate: new Date().toISOString(),
                family: 'Gowsters',
                config: config,
                sightings: sightings,
                customAnimals: customAnimals
            };
            
            const json = JSON.stringify(backup, null, 2);
            downloadFile(json, `gowsters-safari-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }
        
        // Make downloadBackup available globally
        window.downloadBackup = downloadBackup;

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    config = backup.config;
                    sightings = backup.sightings;
                    customAnimals = backup.customAnimals || {};
                    
                    saveConfig();
                    saveSightings();
                    
                    showNotification('‚úÖ Backup restored!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showNotification('‚ùå Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // Make restoreBackup available globally
        window.restoreBackup = restoreBackup;
        
        function shareLink() {
            if (!config.serverUrl) {
                showNotification('üìµ Configure server first to share', 'error');
                return;
            }
            
            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams({
                server: config.serverUrl,
                password: config.password,
                name: '' // Leave blank for them to fill
            });
            
            const shareUrl = `${baseUrl}?${params.toString()}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                showNotification('üîó Link copied! Share with family', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = shareUrl;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showNotification('üîó Link copied! Share with family', 'success');
            });
        }
        
        // Make shareLink available globally
        window.shareLink = shareLink;

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Set up auto-populate for emoji field after a small delay to ensure DOM is ready
            setTimeout(() => {
                const animalInput = document.getElementById('modalAnimal');
                const emojiInput = document.getElementById('modalEmoji');
                
                if (animalInput && emojiInput) {
                    animalInput.addEventListener('input', function() {
                        const selectedAnimal = this.value;
                        
                        // Check common animals
                        const commonAnimal = commonAnimals.find(a => a.name === selectedAnimal);
                        if (commonAnimal) {
                            emojiInput.value = commonAnimal.emoji;
                            return;
                        }
                        
                        // Check additional animals
                        if (additionalAnimals[selectedAnimal]) {
                            emojiInput.value = additionalAnimals[selectedAnimal];
                            return;
                        }
                        
                        // Check custom animals
                        if (customAnimals[selectedAnimal]) {
                            emojiInput.value = customAnimals[selectedAnimal];
                        }
                    });
                }
            }, 100);
        });
    </script>
</body>
</html>