<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gowsters Safari Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow-x: hidden;
        }

        /* Safari background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 50 Q25 30 50 50 T100 50' stroke='%23ffffff10' stroke-width='0.5' fill='none'/%3E%3Ccircle cx='20' cy='80' r='1' fill='%23ffffff08'/%3E%3Ccircle cx='80' cy='20' r='1' fill='%23ffffff08'/%3E%3Ccircle cx='60' cy='70' r='0.5' fill='%23ffffff05'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 100 Q75 80 100 100 T150 100' stroke='%23ffffff08' stroke-width='1' fill='none'/%3E%3C/svg%3E");
            background-position: 0 0, 50px 50px;
            background-size: 100px 100px, 200px 200px;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
            will-change: transform;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'üåç';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .family-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
            will-change: transform;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        h1 {
            color: #333;
            font-size: 26px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .safari-icon {
            animation: bounce 2s ease-in-out infinite;
            will-change: transform;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .sync-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .online {
            background: #10b981;
            color: white;
        }

        .online::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            box-shadow: 0 0 20px 5px rgba(16, 185, 129, 0.8);
            opacity: 0.5;
            animation: glow-opacity 2s ease-in-out infinite;
            will-change: opacity;
            z-index: -1;
        }

        @keyframes glow-opacity {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .offline {
            background: #f59e0b;
            color: white;
        }

        .user-info {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .user-info label {
            font-weight: bold;
            color: #667eea;
        }

        .user-info input {
            padding: 5px 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 5px;
            font-size: 14px;
            background: white;
            font-weight: bold;
            color: #333;
        }

        .welcome-message {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .checklist-header {
            background: white;
            border-radius: 20px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out 0.1s both;
        }

        .checklist-header h2 {
            color: #333;
            margin-bottom: 5px;
        }

        .checklist-header p {
            color: #666;
            font-size: 14px;
        }

        .animals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animal-btn {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            will-change: transform, border-color, box-shadow;
            text-align: center;
        }

        .animal-btn:active {
            transform: scale(0.95);
        }

        .animal-emoji {
            font-size: 36px;
            margin-bottom: 5px;
            display: block;
            will-change: transform;
        }

        .animal-btn:hover .animal-emoji {
            animation: wiggle 1.5s ease-in-out infinite;
        }

        @keyframes wiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-4deg);
            }

            75% {
                transform: rotate(4deg);
            }
        }

        .animal-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .animal-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .animal-count.pop {
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Rarity indicator styles */
        .rarity-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .rarity-very-common {
            background: #10b981;
            color: white;
        }

        .rarity-common {
            background: #3b82f6;
            color: white;
        }

        .rarity-uncommon {
            background: #f59e0b;
            color: white;
        }

        .rarity-rare {
            background: #ef4444;
            color: white;
        }

        .rarity-very-rare {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .rarity-points {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: #fbbf24;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .add-sighting-form {
            display: flex;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .add-sighting-form input[type="text"] {
            flex-grow: 1;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
        }

        .add-sighting-form input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-sighting-form input[type="number"] {
            width: 60px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .add-sighting-form button {
            padding: 10px 15px;
        }

        .sightings-list {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .sighting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .sighting-item:hover {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            transform: translateX(5px);
        }

        .sighting-user {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .sighting-info {
            flex: 1;
        }

        .sighting-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .btn-small:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .actions {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-content .tip-box {
            margin-top: 10px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .summary {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .summary h2 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            font-weight: 600;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            animation: slideUpNotification 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .notification.info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideUpNotification {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOutNotification {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="family-badge">GOWSTERS FAMILY</div>
            <h1><span class="safari-icon">ü¶Å</span> Safari Wildlife Tracker</h1>
            <div class="welcome-message" id="welcomeMessage"></div>
            <div class="status">
                <div class="sync-status" id="syncStatus">Checking...</div>
                <div class="user-info">
                    <label>Tracker:</label>
                    <input type="text" id="userName" placeholder="Your name" />
                </div>
            </div>
        </div>

        <div class="checklist-header">
            <h2>üêÜ Umbabat Animal Checklist</h2>
            <p>Tap an animal to quickly log a sighting. Rarity indicators show how special your sighting is!</p>
        </div>

        <div class="animals-grid" id="animalsGrid"></div>

        <div class="add-sighting-form">
            <input type="text" id="newAnimalName" placeholder="Log another animal (e.g., Honey Badger)">
            <input type="number" id="newAnimalCount" value="1" min="1">
            <button id="addNewSightingBtn" class="btn btn-primary">Log</button>
        </div>

        <div class="sightings-list">
            <h2>üìù Recent Sightings</h2>
            <div id="sightingsList"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" id="forceSyncBtn">üîÑ Force Sync</button>
            <button class="btn btn-secondary" id="exportDataBtn">üìä Export Data</button>
            <button class="btn btn-secondary" id="backupBtn">üíæ Backup</button>
            <input type="file" id="restoreFile" style="display: none" accept=".json">
            <button class="btn btn-secondary" id="restoreBtn">üìÇ Restore</button>
            <button class="btn btn-secondary" id="shareLinkBtn">üîó Share Link</button>
        </div>

        <div class="summary">
            <h2>üìä Trip Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-value" id="totalSightings">0</div>
                    <div class="stat-label">Total Sightings</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="uniqueAnimals">0</div>
                    <div class="stat-label">Unique Animals</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="todaySightings">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="rarityScore">0</div>
                    <div class="stat-label">Rarity Points</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal active" id="setupModal">
        <div class="modal-content">
            <div class="family-badge" style="margin-bottom: 15px;">GOWSTERS FAMILY</div>
            <h2>ü¶Å Welcome to the Safari!</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;" id="setupMessage">Please enter your name to
                start tracking.</p>
            <input type="text" id="setupName" placeholder="Your name (e.g., Sam)">
            <input type="text" id="serverUrl" placeholder="Server URL (optional)">
            <input type="password" id="serverPassword" placeholder="Family password (optional)">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="skipSetupBtn">Use Offline Only</button>
                <button class="btn btn-primary" id="saveSetupBtn">Start Tracking!</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editSightingModal">
        <div class="modal-content">
            <h2 id="editModalTitle">Edit Sighting</h2>
            <input type="number" id="editModalCount" min="1">
            <input type="text" id="editModalNotes" placeholder="Notes (optional)">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Animal rarity data based on real safari sighting difficulty
        const animalRarity = {
            // Very Common (5 points) - seen almost daily
            'Impala': { rarity: 'very-common', points: 5 },
            'Warthog': { rarity: 'very-common', points: 5 },
            'Zebra': { rarity: 'very-common', points: 5 },
            'Elephant': { rarity: 'very-common', points: 5 },
            'Buffalo': { rarity: 'very-common', points: 5 },
            'Giraffe': { rarity: 'very-common', points: 5 },
            'Hippo': { rarity: 'very-common', points: 5 },
            'Baboon': { rarity: 'very-common', points: 5 },

            // Common (10 points) - frequently spotted
            'Lion': { rarity: 'common', points: 10 },
            'Kudu': { rarity: 'common', points: 10 },
            'Antelope': { rarity: 'common', points: 10 },

            // Uncommon (25 points) - need some luck/effort
            'Leopard': { rarity: 'uncommon', points: 25 },
            'Hyena': { rarity: 'uncommon', points: 25 },
            'Crocodile': { rarity: 'uncommon', points: 25 },
            'Eagle': { rarity: 'uncommon', points: 25 },
            'Vulture': { rarity: 'uncommon', points: 25 },

            // Rare (50 points) - elusive, require patience
            'Rhino': { rarity: 'rare', points: 50 },
            'Cheetah': { rarity: 'rare', points: 50 },
            'Wild Dog': { rarity: 'rare', points: 50 },

            // Very Rare (100 points) - exceptional sightings
            'Pangolin': { rarity: 'very-rare', points: 100 },
            'Aardvark': { rarity: 'very-rare', points: 100 },
            'Honey Badger': { rarity: 'very-rare', points: 100 },
            'Serval': { rarity: 'very-rare', points: 100 },
            'African Wild Cat': { rarity: 'very-rare', points: 100 }
        };

        const umbabatAnimals = [
            { name: 'Lion', emoji: 'ü¶Å' }, { name: 'Elephant', emoji: 'üêò' },
            { name: 'Buffalo', emoji: 'üêÉ' }, { name: 'Leopard', emoji: 'üêÜ' },
            { name: 'Rhino', emoji: 'ü¶è' }, { name: 'Giraffe', emoji: 'ü¶í' },
            { name: 'Zebra', emoji: 'ü¶ì' }, { name: 'Hippo', emoji: 'ü¶õ' },
            { name: 'Hyena', emoji: 'üê∫' }, { name: 'Warthog', emoji: 'üêó' },
            { name: 'Kudu', emoji: 'ü¶å' }, { name: 'Impala', emoji: 'ü¶å' },
            { name: 'Wild Dog', emoji: 'üêï' }, { name: 'Cheetah', emoji: 'üêÜ' },
            { name: 'Crocodile', emoji: 'üêä' }, { name: 'Vulture', emoji: 'ü¶Ö' },
            { name: 'Eagle', emoji: 'ü¶Ö' }, { name: 'Antelope', emoji: 'ü¶å' },
            { name: 'Baboon', emoji: 'üêµ' }
        ];

        const animalEmojiMap = {
            'lion': 'ü¶Å', 'elephant': 'üêò', 'buffalo': 'üêÉ', 'leopard': 'üêÜ', 'rhino': 'ü¶è', 'giraffe': 'ü¶í',
            'zebra': 'ü¶ì', 'hippo': 'ü¶õ', 'hyena': 'üê∫', 'warthog': 'üêó', 'kudu': 'ü¶å', 'impala': 'ü¶å',
            'wild dog': 'üêï', 'cheetah': 'üêÜ', 'crocodile': 'üêä', 'vulture': 'ü¶Ö', 'eagle': 'ü¶Ö',
            'antelope': 'ü¶å', 'baboon': 'üêµ', 'monkey': 'üêí', 'vervet monkey': 'üêµ', 'wildebeest': 'üêÉ',
            'honey badger': 'ü¶°', 'jackal': 'ü¶ä', 'mongoose': 'ü¶¶', 'porcupine': 'ü¶î', 'tortoise': 'üê¢',
            'pangolin': 'ü¶¶', 'aardvark': 'üê∑', 'serval': 'üêÜ', 'african wild cat': 'üêà'
        };

        // State variables
        let customAnimals = {};
        let sightings = [];
        let config = {
            userName: '',
            serverUrl: '',
            password: '',
            deviceId: generateId()
        };
        let isOnline = false;
        let editingSightingId = null;
        let onlineInterval, syncInterval;

        // Core Functions
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlName = urlParams.get('name');
            const urlPassword = urlParams.get('password');
            const urlServer = urlParams.get('server');

            loadConfig();
            loadSightings();

            if (urlServer && urlPassword) {
                let serverUrl = decodeURIComponent(urlServer);
                if (serverUrl && !serverUrl.startsWith('http')) {
                    serverUrl = 'https://' + serverUrl;
                }
                config.serverUrl = serverUrl;
                config.password = decodeURIComponent(urlPassword);

                const serverInput = document.getElementById('serverUrl');
                const passwordInput = document.getElementById('serverPassword');
                serverInput.value = config.serverUrl;
                serverInput.style.display = 'none';
                passwordInput.value = config.password;
                passwordInput.style.display = 'none';

                if (urlName) {
                    config.userName = decodeURIComponent(urlName);
                    document.getElementById('setupModal').classList.remove('active');
                } else {
                    document.getElementById('setupMessage').textContent = "You've joined the Gowsters safari! Just add your name to begin.";
                    document.getElementById('skipSetupBtn').style.display = 'none';
                }
            }

            saveConfig();
            startOnlineServices();
            addEventListeners();
            renderAnimals();
            updateDisplay();
            updateWelcomeMessage();
            document.getElementById('userName').value = config.userName || '';

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (onlineInterval) clearInterval(onlineInterval);
                if (syncInterval) clearInterval(syncInterval);
            });
        }

        function addEventListeners() {
            document.getElementById('userName').addEventListener('change', (e) => {
                config.userName = e.target.value;
                saveConfig();
                updateWelcomeMessage();
            });
            document.getElementById('addNewSightingBtn').addEventListener('click', handleAddNewSighting);
            document.getElementById('newAnimalName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAddNewSighting();
            });
            document.getElementById('forceSyncBtn').addEventListener('click', () => syncNow(true));
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('backupBtn').addEventListener('click', downloadBackup);
            document.getElementById('restoreBtn').addEventListener('click', () => document.getElementById('restoreFile').click());
            document.getElementById('restoreFile').addEventListener('change', restoreBackup);
            document.getElementById('shareLinkBtn').addEventListener('click', shareLink);
            document.getElementById('skipSetupBtn').addEventListener('click', skipSetup);
            document.getElementById('saveSetupBtn').addEventListener('click', saveSetup);
            document.getElementById('cancelEditBtn').addEventListener('click', () => document.getElementById('editSightingModal').classList.remove('active'));
            document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
        }

        function updateWelcomeMessage() {
            const welcomeEl = document.getElementById('welcomeMessage');
            if (config.userName) {
                const greetings = [`Happy spotting, ${config.userName}! üåç`, `${config.userName}'s wildlife adventure ü¶í`];
                welcomeEl.textContent = greetings[Math.floor(Math.random() * greetings.length)];
            } else {
                welcomeEl.textContent = 'Welcome to the Gowsters Safari! üåç';
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getRarityInfo(animalName) {
            return animalRarity[animalName] || { rarity: 'common', points: 10 };
        }

        function calculateTotalRarityScore() {
            const activeSightings = sightings.filter(s => !s.deleted);
            return activeSightings.reduce((total, sighting) => {
                const rarityInfo = getRarityInfo(sighting.animal);
                return total + (rarityInfo.points * sighting.count);
            }, 0);
        }

        // Data Persistence
        function loadConfig() {
            const saved = localStorage.getItem('safariConfig');
            if (saved) config = { ...config, ...JSON.parse(saved) };
        }

        function saveConfig() {
            localStorage.setItem('safariConfig', JSON.stringify(config));
        }

        function loadSightings() {
            const savedSightings = localStorage.getItem('safariSightings');
            if (savedSightings) sightings = JSON.parse(savedSightings);
            const savedCustom = localStorage.getItem('customAnimals');
            if (savedCustom) customAnimals = JSON.parse(savedCustom);
        }

        function saveSightings() {
            localStorage.setItem('safariSightings', JSON.stringify(sightings));
            localStorage.setItem('customAnimals', JSON.stringify(customAnimals));
            updateDisplay();
        }

        function startOnlineServices() {
            if (onlineInterval) clearInterval(onlineInterval);
            if (syncInterval) clearInterval(syncInterval);

            if (config.serverUrl) {
                syncNow(false);
                onlineInterval = setInterval(checkOnlineStatus, 10000);
                syncInterval = setInterval(autoSync, 15000);
            }
        }

        // Setup and Modals
        function saveSetup() {
            config.userName = document.getElementById('setupName').value || 'Anonymous Gowster';
            config.serverUrl = document.getElementById('serverUrl').value;
            config.password = document.getElementById('serverPassword').value;

            if (config.serverUrl && !config.serverUrl.startsWith('http')) {
                config.serverUrl = 'https://' + config.serverUrl;
            }
            saveConfig();
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('userName').value = config.userName;
            updateWelcomeMessage();
            startOnlineServices();
        }

        function skipSetup() {
            config.userName = 'Anonymous Gowster';
            config.serverUrl = '';
            config.password = '';
            saveConfig();
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('userName').value = config.userName;
            updateWelcomeMessage();
            updateOnlineStatus(false);
        }

        // Sightings Management
        function handleAddNewSighting() {
            const nameInput = document.getElementById('newAnimalName');
            const countInput = document.getElementById('newAnimalCount');
            const animalName = nameInput.value.trim();
            const count = parseInt(countInput.value) || 1;

            if (!animalName) return;

            const formattedName = animalName.split(' ').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
            const emoji = animalEmojiMap[formattedName.toLowerCase()] || 'üêæ';

            addSighting(formattedName, count, '', emoji);

            nameInput.value = '';
            countInput.value = 1;
            nameInput.focus();
        }

        function addSighting(animal, count = 1, notes = '', emoji = '') {
            const isBuiltInAnimal = umbabatAnimals.some(a => a.name === animal);
            const isNewCustomAnimal = !isBuiltInAnimal && !customAnimals[animal];
            if (isNewCustomAnimal) {
                customAnimals[animal] = emoji;
            }

            const rarityInfo = getRarityInfo(animal);
            const pointsEarned = rarityInfo.points * count;

            sightings.push({
                id: generateId(),
                animal,
                emoji,
                count: parseInt(count),
                notes,
                timestamp: new Date().toISOString(),
                user: config.userName || 'Anonymous',
                deviceId: config.deviceId,
                synced: false,
                deleted: false
            });

            saveSightings();

            // Show special notification for rare sightings
            if (rarityInfo.rarity === 'very-rare') {
                showNotification(`üéâ INCREDIBLE! ${animal} (+${pointsEarned} pts)`, 'success');
            } else if (rarityInfo.rarity === 'rare') {
                showNotification(`‚≠ê Excellent spot! ${animal} (+${pointsEarned} pts)`, 'success');
            } else {
                showNotification('‚ú® Logged!', 'success');
            }

            if (isNewCustomAnimal) {
                renderAnimals();
            } else {
                updateAnimalCount(animal);
            }
        }

        function openEditModal(sightingId) {
            editingSightingId = sightingId;
            const sighting = sightings.find(s => s.id === sightingId);
            if (!sighting) return;

            document.getElementById('editModalTitle').textContent = `Edit ${sighting.emoji} ${sighting.animal}`;
            document.getElementById('editModalCount').value = sighting.count;
            document.getElementById('editModalNotes').value = sighting.notes || '';
            document.getElementById('editSightingModal').classList.add('active');
        }

        function saveEdit() {
            if (!editingSightingId) return;
            const sighting = sightings.find(s => s.id === editingSightingId);
            if (!sighting) return;

            sighting.count = parseInt(document.getElementById('editModalCount').value) || 1;
            sighting.notes = document.getElementById('editModalNotes').value.trim();
            sighting.synced = false; // Mark as needing sync
            sighting.timestamp = new Date().toISOString(); // Update timestamp for sync

            saveSightings();
            document.getElementById('editSightingModal').classList.remove('active');
            editingSightingId = null;
            showNotification('‚úèÔ∏è Sighting updated!', 'info');
        }

        function deleteSighting(id) {
            const sighting = sightings.find(s => s.id === id);
            if (sighting) {
                sighting.deleted = true;
                sighting.synced = false;
                sighting.timestamp = new Date().toISOString(); // Update timestamp for sync
                saveSightings();
                showNotification('Sighting deleted', 'error');
            }
        }

        // UI Rendering
        function renderAnimals() {
            const grid = document.getElementById('animalsGrid');
            grid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            const animalsToDisplay = [...umbabatAnimals];
            Object.entries(customAnimals).forEach(([name, emoji]) => {
                if (!animalsToDisplay.some(a => a.name === name)) {
                    animalsToDisplay.push({ name, emoji });
                }
            });

            const createAnimalButton = (animal, index) => {
                const totalCount = sightings
                    .filter(s => s.animal === animal.name && !s.deleted)
                    .reduce((sum, s) => sum + s.count, 0);

                const rarityInfo = getRarityInfo(animal.name);
                const btn = document.createElement('div');
                btn.className = 'animal-btn';
                btn.style.setProperty('--index', index);

                let rarityBadge = '';
                let pointsBadge = '';
                if (rarityInfo) {
                    rarityBadge = `<div class="rarity-badge rarity-${rarityInfo.rarity}">${rarityInfo.rarity.replace('-', ' ')}</div>`;
                    pointsBadge = `<div class="rarity-points">+${rarityInfo.points} pts</div>`;
                }

                btn.innerHTML = `
                    ${rarityBadge}
                    ${pointsBadge}
                    <div class="animal-emoji">${animal.emoji}</div>
                    <div class="animal-name">${animal.name}</div>
                    <div class="animal-count" id="count-${animal.name.replace(/\s/g, '')}">${totalCount}</div>
                `;
                btn.addEventListener('click', () => addSighting(animal.name, 1, '', animal.emoji));
                return btn;
            };

            animalsToDisplay.sort((a, b) => {
                const rarityA = getRarityInfo(a.name);
                const rarityB = getRarityInfo(b.name);
                if (rarityA.points !== rarityB.points) {
                    return rarityB.points - rarityA.points; // Sort by rarity (rarest first)
                }
                return a.name.localeCompare(b.name);
            }).forEach((animal, index) => {
                const hasBeenSighted = sightings.some(s => s.animal === animal.name && !s.deleted);
                if (umbabatAnimals.some(a => a.name === animal.name) || hasBeenSighted) {
                    fragment.appendChild(createAnimalButton(animal, index));
                }
            });

            grid.appendChild(fragment);
        }

        function updateDisplay() {
            const activeSightings = sightings.filter(s => !s.deleted);
            const totalCount = activeSightings.reduce((sum, s) => sum + s.count, 0);
            const uniqueCount = new Set(activeSightings.map(s => s.animal)).size;
            const today = new Date().toDateString();
            const todayCount = activeSightings.filter(s => new Date(s.timestamp).toDateString() === today).reduce((sum, s) => sum + s.count, 0);
            const rarityScore = calculateTotalRarityScore();

            document.getElementById('totalSightings').textContent = totalCount;
            document.getElementById('uniqueAnimals').textContent = uniqueCount;
            document.getElementById('todaySightings').textContent = todayCount;
            document.getElementById('rarityScore').textContent = rarityScore;
            updateOnlineStatus(isOnline);

            const list = document.getElementById('sightingsList');
            list.innerHTML = '';
            const fragment = document.createDocumentFragment();
            [...activeSightings].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 15).forEach(sighting => {
                const rarityInfo = getRarityInfo(sighting.animal);
                const item = document.createElement('div');
                item.className = 'sighting-item';
                item.innerHTML = `
                    <div class="sighting-info">
                        <strong>${sighting.emoji} ${sighting.count} √ó ${sighting.animal}</strong>
                        <span class="sighting-user">${sighting.user}</span><br>
                        <small style="color: #999;">${new Date(sighting.timestamp).toLocaleString()}</small>
                        ${sighting.notes ? `<br><small style="color: #666;">üìù ${sighting.notes}</small>` : ''}
                        ${rarityInfo ? `<br><small style="color: #764ba2;">‚≠ê ${rarityInfo.points * sighting.count} rarity points</small>` : ''}
                    </div>
                    <div class="sighting-actions">
                        <button class="btn-small btn-edit" data-id="${sighting.id}">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" data-id="${sighting.id}">üóëÔ∏è</button>
                    </div>`;
                fragment.appendChild(item);
            });
            list.appendChild(fragment);
            list.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', () => openEditModal(btn.dataset.id));
            });
            list.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', () => deleteSighting(btn.dataset.id));
            });

            [...umbabatAnimals, ...Object.keys(customAnimals).map(name => ({ name }))].forEach(animal => updateAnimalCount(animal.name));
        }

        function updateAnimalCount(animal) {
            const countEl = document.getElementById(`count-${animal.replace(/\s/g, '')}`);
            if (countEl) {
                const totalCount = sightings
                    .filter(s => s.animal === animal && !s.deleted)
                    .reduce((sum, s) => sum + s.count, 0);
                countEl.textContent = totalCount;
                countEl.classList.add('pop');
                setTimeout(() => countEl.classList.remove('pop'), 300);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'fadeOutNotification 0.3s ease-out forwards';
                notification.addEventListener('animationend', () => notification.remove());
            }, 2000);
        }

        // Networking and Sync - FIXED to handle deletes properly
        async function checkOnlineStatus() {
            if (!config.serverUrl) return updateOnlineStatus(false);
            try {
                const response = await fetch(`${config.serverUrl}/health`, { headers: { 'X-Password': config.password } });
                updateOnlineStatus(response.ok);
            } catch (error) {
                updateOnlineStatus(false);
            }
        }

        function updateOnlineStatus(online) {
            isOnline = online;
            const status = document.getElementById('syncStatus');
            const pendingCount = sightings.filter(s => !s.synced).length;
            if (!config.serverUrl) {
                status.textContent = 'üìµ Offline Only';
                status.className = 'sync-status offline';
            } else if (online) {
                status.textContent = pendingCount > 0 ? `üåê Online (${pendingCount} pending)` : 'üåê All synced';
                status.className = 'sync-status online';
            } else {
                status.textContent = 'üìµ Offline';
                status.className = 'sync-status offline';
            }
        }

        async function syncNow(showFeedback = true) {
            if (!config.serverUrl) {
                if (showFeedback) showNotification('Offline mode, cannot sync.', 'info');
                return;
            }
            try {
                // First, send all unsynced changes (including deletes)
                const unsynced = sightings.filter(s => !s.synced);
                if (unsynced.length > 0) {
                    await fetch(`${config.serverUrl}/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Password': config.password },
                        body: JSON.stringify({ deviceId: config.deviceId, sightings: unsynced })
                    });
                }

                // Then fetch all sightings from server
                const getRes = await fetch(`${config.serverUrl}/sightings`, { headers: { 'X-Password': config.password } });
                if (getRes.ok) {
                    const serverSightings = await getRes.json();
                    mergeSightings(serverSightings);
                    if (showFeedback) showNotification('‚úÖ All synced', 'success');
                } else {
                    throw new Error('Failed to fetch sightings');
                }
                updateOnlineStatus(true);
            } catch (error) {
                updateOnlineStatus(false);
                if (showFeedback) showNotification('‚ùå Sync failed', 'error');
            }
        }

        function mergeSightings(serverSightings) {
            const localSightingMap = new Map(sightings.map(s => [s.id, s]));

            // Process server sightings
            serverSightings.forEach(serverSighting => {
                const local = localSightingMap.get(serverSighting.id);
                if (!local) {
                    // New sighting from server
                    sightings.push({ ...serverSighting, synced: true });
                    const isBuiltIn = umbabatAnimals.some(a => a.name === serverSighting.animal);
                    if (serverSighting.emoji && !isBuiltIn) {
                        customAnimals[serverSighting.animal] = serverSighting.emoji;
                    }
                } else {
                    // Existing sighting - use most recent version
                    const serverTime = new Date(serverSighting.timestamp);
                    const localTime = new Date(local.timestamp);

                    if (serverTime > localTime) {
                        // Server version is newer
                        Object.assign(local, serverSighting, { synced: true });
                    } else if (localTime > serverTime && !local.synced) {
                        // Local version is newer and unsynced - keep local
                        // This handles the case where we edited or deleted locally
                    } else {
                        // Mark as synced if timestamps match
                        local.synced = true;
                    }
                }
            });

            // Mark all local changes as synced after successful merge
            sightings.forEach(s => {
                if (!s.synced) {
                    s.synced = true;
                }
            });

            saveSightings();
            renderAnimals();
        }

        async function autoSync() {
            if (isOnline && config.serverUrl) {
                await syncNow(false);
            }
        }

        // Data Utilities
        function exportData() {
            const data = sightings.filter(s => !s.deleted);
            const escapeCSV = (str) => `"${String(str || '').replace(/"/g, '""')}"`;
            const csv = [['Animal', 'Count', 'Date', 'Time', 'User', 'Notes', 'Rarity Points'].join(','), ...data.map(s => {
                const d = new Date(s.timestamp);
                const rarityInfo = getRarityInfo(s.animal);
                return [
                    escapeCSV(s.animal),
                    s.count,
                    d.toLocaleDateString(),
                    d.toLocaleTimeString(),
                    escapeCSV(s.user),
                    escapeCSV(s.notes),
                    rarityInfo.points * s.count
                ].join(',');
            })
            ].join('\n');
            downloadFile(csv, `gowsters-safari-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function downloadBackup() {
            const backup = { version: 1, config, sightings, customAnimals };
            downloadFile(JSON.stringify(backup, null, 2), `gowsters-safari-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.config || !backup.sightings) throw new Error("Invalid format");
                    config = backup.config;
                    sightings = backup.sightings;
                    customAnimals = backup.customAnimals || {};
                    saveConfig();
                    saveSightings();
                    showNotification('‚úÖ Backup restored!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showNotification('‚ùå Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
        }

        function shareLink() {
            if (!config.serverUrl) return showNotification('üìµ Configure server first to share', 'error');
            const params = new URLSearchParams({ server: config.serverUrl, password: config.password });
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showNotification('üîó Link copied! Share with family', 'success');
            }).catch(() => showNotification('Could not copy link', 'error'));
        }

        function downloadFile(content, filename, type) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type }));
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>